# Duel - V1 Specification

**Version:** 1.0.0  
**Last Updated:** October 8, 2025  
**Status:** üöß Planning Phase

---

## üìã Table of Contents
1. [Vision](#vision)
2. [V1 Scope](#v1-scope)
3. [Game Rules: Muffs](#game-rules-muffs)
4. [User Flow](#user-flow)
5. [Technical Architecture](#technical-architecture)
6. [Database Schema](#database-schema)
7. [Implementation Roadmap](#implementation-roadmap)
8. [Open Questions](#open-questions)

---

## üéØ Vision

**Duel** is a real-time competitive platform where two players compete in cognitive skill challenges with an element of luck. The platform combines mental math games, probability challenges, and "wheel of fortune" style game selection to create a fun, dopamine-driven experience.

**Core Philosophy:**
- Skill matters, but luck can always tip the scales
- Fast-paced rounds keep engagement high
- Win or lose - no draws (forces decisive outcomes)

---

## üîí V1 Scope

### ‚úÖ INCLUDED
- User registration and login (username/password only)
- Lobby system (create, join, list public lobbies)
- Real-time lobby with ready mechanism
- **One game type: Muffs** (mental math)
- 5-round matches (Best of 5)
- Fastest correct answer wins
- Match summary page
- Auto-forfeit on disconnect

### ‚ùå EXCLUDED (V2+)
- Multiple game types (blackjack, slots, etc.)
- Wheel of fortune / game picker
- Token/wallet system
- Purchases & daily rewards
- Leaderboards
- ELO/ranking system
- Private lobbies
- Email verification
- Password reset
- Reconnection grace period
- Spectator mode
- Chat system

---

## üßÆ Game Rules: Muffs

### Overview
Muffs is a mental math speed challenge. Players race to solve randomly generated mathematical expressions.

### Match Structure
- **Rounds per match:** 5 (fixed)
- **Winner determination:** Best of 5 (first to 3 round wins)
- **Tie scenario:** If 2-2 after 5 rounds, both players lose (no tiebreaker)

### Round Rules
- **Winning condition:** First player to submit correct answer wins the round
- **Both wrong:** No points awarded, round ends after time expires
- **Time limits:** Based on difficulty (see below)

### Difficulty Settings
When creating a lobby, host selects one difficulty for the entire match:

| Difficulty | Time Limit | Expression Complexity |
|-----------|------------|----------------------|
| **Easy**  | 4 seconds  | Simple: `3 + 5`, `10 - 7` |
| **Medium**| 8 seconds  | Moderate: `(2 + 3) * 4`, `15 % 4` |
| **Hard**  | 12 seconds | Complex: `sqrt(16) + factorial(3) % 5` |

**Note:** Values are starting points and will be tuned during playtesting.

### Expression Engine Features
The Muffs engine supports:
- **Binary operators:** `+`, `-`, `*`, `/`, `%`, `^`
- **Unary operators:** `minus()`, `abs()`, `sqrt()`, `factorial()`
- **Parentheses:** Nested grouping for complex expressions
- **Precedence:** Standard mathematical operator precedence

---

## üîÑ User Flow

### 1. Landing Page (Unauthenticated)
- Login form
- Register link
- No anonymous play

### 2. Registration
- Username (unique)
- Password (min 8 chars)
- Submit ‚Üí Auto-login ‚Üí Redirect to Main Page

### 3. Main Page (Authenticated)
- **Lobby List:** Shows all public lobbies (status: waiting/in-progress)
- **Create Lobby:** Button opens modal
  - Select difficulty (Easy/Medium/Hard)
  - Submit ‚Üí Create lobby ‚Üí Redirect to Lobby Page

### 4. Lobby Page (Waiting Room)
- Shows host and guest (if joined)
- Ready button for each player
- Leave button
- Real-time updates via SignalR

**Conditions:**
- Lobby needs 2 players
- Both must press ready
- Once both ready ‚Üí Auto-start match (redirect to Game Page)

### 5. Game Page (Muffs Match)
- **Display:**
  - Current round (e.g., "Round 2 of 5")
  - Score (e.g., "You: 1 | Opponent: 0")
  - Expression (large, centered)
  - Timer (countdown)
  - Answer input field
- **Flow:**
  - Expression appears ‚Üí Timer starts
  - Player types answer ‚Üí Submits
  - Round ends when: (1) correct answer submitted, or (2) timer expires
  - Brief results screen (who won the round)
  - Auto-advance to next round
- **After 5 rounds:** Redirect to Summary Page

### 6. Summary Page
- Winner announcement (or "Both Lost" if tied)
- Match stats (rounds won, average response time)
- Funny animations/confetti for winner
- Auto-redirect to Main Page after 5 seconds

---

## üèóÔ∏è Technical Architecture

### Modular Monolith Structure
```
src/
‚îú‚îÄ‚îÄ Web/
‚îÇ   ‚îî‚îÄ‚îÄ Duel.API/              # ASP.NET Core Web API + SignalR
‚îú‚îÄ‚îÄ Identity/
‚îÇ   ‚îú‚îÄ‚îÄ Duel.Modules.Identity/      # User accounts, auth, JWT
‚îÇ   ‚îî‚îÄ‚îÄ Duel.Modules.Identity.Tests/
‚îú‚îÄ‚îÄ Lobby/
‚îÇ   ‚îú‚îÄ‚îÄ Duel.Modules.Lobby/         # Lobbies, matches, orchestration
‚îÇ   ‚îî‚îÄ‚îÄ Duel.Modules.Lobby.Tests/
‚îú‚îÄ‚îÄ Engine/
‚îÇ   ‚îú‚îÄ‚îÄ Duel.Modules.Engine/        # Game logic (Muffs ‚úÖ)
‚îÇ   ‚îî‚îÄ‚îÄ Duel.Modules.Engine.Tests/
‚îî‚îÄ‚îÄ Shared/
    ‚îî‚îÄ‚îÄ Duel.Shared/           # Shared kernel (exceptions, primitives)
```

### Technology Stack
- **Backend:** ASP.NET Core 9.0 (C#)
- **Real-time:** SignalR (WebSockets)
- **Database:** PostgreSQL
- **Cache:** Redis (for session state, lobby lists)
- **Authentication:** JWT tokens (custom implementation)
- **Frontend:** TBD (React/Vue/Blazor)
- **Deployment:** Docker + Docker Compose

### Module Responsibilities

#### Identity Module
- User registration (hash passwords with BCrypt)
- Login (issue JWT tokens)
- Auth middleware (validate tokens)
- Exposes: `IUserService`, `IAuthService`

#### Lobby Module
- Lobby CRUD (create, list, join, leave)
- Match orchestration (round progression, scoring)
- SignalR hub for real-time events
- Integrates with Engine module for game logic
- Exposes: `ILobbyService`, `IMatchService`

#### Engine Module
- Game logic (currently: Muffs only)
- Expression generation based on difficulty
- Answer validation
- Exposes: `IGameEngine` (abstraction for multiple game types)

---

## üóÑÔ∏è Database Schema

### PostgreSQL Tables

#### Users (Identity Module)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_users_username ON users(username);
```

#### Lobbies (Lobby Module)
```sql
CREATE TABLE lobbies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    host_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    guest_id UUID REFERENCES users(id) ON DELETE SET NULL,
    difficulty VARCHAR(10) NOT NULL CHECK (difficulty IN ('Easy', 'Medium', 'Hard')),
    status VARCHAR(20) NOT NULL CHECK (status IN ('Waiting', 'Ready', 'InProgress', 'Completed', 'Abandoned')),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_lobbies_status ON lobbies(status);
CREATE INDEX idx_lobbies_host ON lobbies(host_id);
```

#### Matches (Lobby Module)
```sql
CREATE TABLE matches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lobby_id UUID NOT NULL REFERENCES lobbies(id) ON DELETE CASCADE,
    player1_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    player2_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    winner_id UUID REFERENCES users(id) ON DELETE SET NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('InProgress', 'Completed', 'Abandoned')),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP
);

CREATE INDEX idx_matches_lobby ON matches(lobby_id);
CREATE INDEX idx_matches_players ON matches(player1_id, player2_id);
```

#### Rounds (Lobby Module)
```sql
CREATE TABLE rounds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    match_id UUID NOT NULL REFERENCES matches(id) ON DELETE CASCADE,
    round_number INT NOT NULL CHECK (round_number BETWEEN 1 AND 5),
    expression VARCHAR(255) NOT NULL,
    correct_answer INT NOT NULL,
    winner_id UUID REFERENCES users(id) ON DELETE SET NULL,
    player1_answer INT,
    player2_answer INT,
    player1_response_time_ms INT,
    player2_response_time_ms INT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP,
    CONSTRAINT unique_match_round UNIQUE (match_id, round_number)
);

CREATE INDEX idx_rounds_match ON rounds(match_id);
```

### Redis Cache Structure
```
lobbies:list           ‚Üí List of active lobby IDs (for quick listing)
lobby:{id}:state       ‚Üí Lobby state (host, guest, ready status)
match:{id}:state       ‚Üí Match state (current round, scores)
user:{id}:connection   ‚Üí SignalR connection ID mapping
```

---

## üöÄ Implementation Roadmap

### Milestone 1: Identity Module üîê
**Goal:** User registration, login, and JWT authentication

#### Tasks
- [ ] Create `Duel.Modules.Identity` project
- [ ] Create `Duel.Modules.Identity.Tests` project
- [ ] Design Identity module structure (Domain, Application, Infrastructure)
- [ ] Implement `User` entity
- [ ] Implement `IUserRepository` interface
- [ ] Implement `UserRepository` with PostgreSQL
- [ ] Implement password hashing (BCrypt)
- [ ] Implement JWT token generation
- [ ] Implement `IAuthService` interface
- [ ] Implement `AuthService` (register, login)
- [ ] Create auth middleware for JWT validation
- [ ] Add Identity endpoints to API:
  - [ ] `POST /api/auth/register`
  - [ ] `POST /api/auth/login`
  - [ ] `GET /api/auth/me` (test protected route)
- [ ] Write unit tests for `AuthService`
- [ ] Write integration tests for auth endpoints
- [ ] Test with Postman/curl

**Definition of Done:**
- ‚úÖ Users can register
- ‚úÖ Users can login and receive JWT token
- ‚úÖ Protected endpoints reject requests without valid token
- ‚úÖ All tests passing

---

### Milestone 2: Lobby Module - REST APIs üéÆ
**Goal:** Basic lobby CRUD operations

#### Tasks
- [ ] Create `Duel.Modules.Lobby` project
- [ ] Create `Duel.Modules.Lobby.Tests` project
- [ ] Design Lobby module structure
- [ ] Implement `Lobby`, `Match`, `Round` entities
- [ ] Implement repositories (`ILobbyRepository`, `IMatchRepository`, `IRoundRepository`)
- [ ] Implement `ILobbyService` interface
- [ ] Implement `LobbyService` (CRUD logic)
- [ ] Add Lobby endpoints to API:
  - [ ] `POST /api/lobbies` (create)
  - [ ] `GET /api/lobbies` (list)
  - [ ] `POST /api/lobbies/{id}/join` (join)
  - [ ] `DELETE /api/lobbies/{id}/leave` (leave)
  - [ ] `GET /api/lobbies/{id}` (get details)
- [ ] Write unit tests for `LobbyService`
- [ ] Write integration tests for lobby endpoints
- [ ] Test with Postman/curl

**Definition of Done:**
- ‚úÖ Users can create lobbies
- ‚úÖ Users can see list of lobbies
- ‚úÖ Users can join/leave lobbies
- ‚úÖ All tests passing

---

### Milestone 3: Lobby Module - SignalR Real-Time ‚ö°
**Goal:** Real-time lobby updates and match orchestration

#### Tasks
- [ ] Add SignalR to `Duel.API`
- [ ] Create `LobbyHub` (SignalR hub)
- [ ] Implement lobby events:
  - [ ] `PlayerJoined`
  - [ ] `PlayerLeft`
  - [ ] `PlayerReady`
  - [ ] `MatchStarting`
- [ ] Implement ready mechanism (both players ready ‚Üí start match)
- [ ] Create `IMatchService` interface
- [ ] Implement `MatchService` (orchestration logic)
- [ ] Create `GameHub` (SignalR hub for match events)
- [ ] Implement match events:
  - [ ] `RoundStarted` (send expression)
  - [ ] `AnswerSubmitted` (from client)
  - [ ] `RoundCompleted` (send results)
  - [ ] `MatchCompleted` (send final scores)
- [ ] Implement round state machine (timing, answer validation, progression)
- [ ] Handle disconnections (auto-forfeit)
- [ ] Write tests for SignalR hubs
- [ ] Test real-time flow with multiple browser tabs

**Definition of Done:**
- ‚úÖ Real-time lobby updates work
- ‚úÖ Match starts when both players ready
- ‚úÖ Rounds progress automatically
- ‚úÖ Disconnect causes forfeit
- ‚úÖ All tests passing

---

### Milestone 4: Engine Integration üßÆ
**Goal:** Wire Muffs engine to lobby orchestration

#### Tasks
- [ ] Create `IGameEngine` abstraction in `Duel.Shared`
- [ ] Implement `MuffsGameEngine` in `Duel.Modules.Engine`
- [ ] Create difficulty configuration mapping:
  - [ ] Easy ‚Üí `ExpressionSettings`
  - [ ] Medium ‚Üí `ExpressionSettings`
  - [ ] Hard ‚Üí `ExpressionSettings`
- [ ] Integrate engine with `MatchService`:
  - [ ] Generate expression at round start
  - [ ] Validate answers
  - [ ] Calculate correct result
- [ ] Add expression serialization (AST ‚Üí string for display)
- [ ] Write tests for difficulty configurations
- [ ] Playtest and tune difficulty settings
- [ ] Write integration tests for engine + match flow

**Definition of Done:**
- ‚úÖ Expressions generate correctly for each difficulty
- ‚úÖ Answers validate properly
- ‚úÖ Match flow works end-to-end with real Muffs game
- ‚úÖ All tests passing

---

### Milestone 5: Frontend üé®
**Goal:** Complete user interface for all flows

#### Tasks
- [ ] Choose frontend framework (React/Vue/Blazor)
- [ ] Set up frontend project
- [ ] Implement pages:
  - [ ] Login/Register page
  - [ ] Main page (lobby list + create button)
  - [ ] Lobby waiting room
  - [ ] Game page (Muffs UI)
  - [ ] Summary page
- [ ] Implement SignalR client integration
- [ ] Implement routing
- [ ] Style UI (modern, responsive design)
- [ ] Add timer visualization
- [ ] Add winner animations
- [ ] Test on multiple devices/browsers
- [ ] End-to-end testing

**Definition of Done:**
- ‚úÖ All pages implemented and functional
- ‚úÖ Real-time updates work smoothly
- ‚úÖ UI is polished and responsive
- ‚úÖ Can play full match from start to finish

---

### Milestone 6: Docker & Deployment üê≥
**Goal:** Production-ready deployment

#### Tasks
- [ ] Update `Dockerfile` for v1 structure
- [ ] Update `docker-compose.yml`:
  - [ ] PostgreSQL service
  - [ ] Redis service
  - [ ] API service
  - [ ] Frontend service (if separate)
- [ ] Add database migrations (SQL scripts)
- [ ] Add health checks
- [ ] Add environment variable configuration
- [ ] Test full stack with Docker Compose
- [ ] Write deployment documentation

**Definition of Done:**
- ‚úÖ `docker-compose up` runs entire application
- ‚úÖ Database initializes correctly
- ‚úÖ Services communicate properly
- ‚úÖ Application is fully functional

---

## ‚ùì Open Questions

### 1. Difficulty Configurability
**Question:** Should lobby hosts be able to configure time limits, or just pick Easy/Medium/Hard?

**Options:**
- **A:** Fixed presets (Easy/Medium/Hard) - simpler for v1
- **B:** Allow time limit slider (4-12s range) - more flexibility

**Decision:** TBD

**Recommendation:** Option A for v1, add configurability in v2 if users request it.

---

### 2. Identity Implementation
**Question:** Use ASP.NET Identity or roll our own?

**Options:**
- **A:** ASP.NET Identity - batteries included, but heavier
- **B:** Custom implementation - lighter, full control, learning experience

**Decision:** TBD

**Recommendation:** Option B - demonstrates deeper understanding for interviews, not that complex for v1 scope.

---

### 3. Frontend Framework
**Question:** Which frontend framework?

**Options:**
- **A:** React - most popular, great ecosystem
- **B:** Vue - simpler learning curve
- **C:** Blazor - stay in C# ecosystem

**Decision:** TBD

**Recommendation:** Depends on what you want to learn/demonstrate.

---

### 4. Expression Serialization
**Question:** How to convert AST to display string?

**Current status:** Parser exists for tests, but no serializer (AST ‚Üí string)

**Example:**
```csharp
// AST: Multiplication(Addition(Constant(2), Constant(3)), Constant(4))
// Display: "(2 + 3) * 4"
```

**Decision:** Implement as part of Milestone 4

---

## üìù Notes

### Development Practices
- Write tests first (TDD) where possible
- Keep commits atomic and descriptive
- Each milestone should be a separate branch
- Code review checklist before merging
- Document design decisions in this file

### Performance Targets (V1)
- Lobby list loads in < 500ms
- Match starts within 1s of both players ready
- Round latency < 100ms (server ‚Üí client)
- Support 10 concurrent matches (v1 goal)

### Security Considerations (V1)
- ‚úÖ Password hashing (BCrypt)
- ‚úÖ JWT expiration (24 hours)
- ‚úÖ Input validation on all endpoints
- ‚ö†Ô∏è Rate limiting (v2)
- ‚ö†Ô∏è HTTPS enforcement (deployment concern)
- ‚ö†Ô∏è Anti-cheat measures (v2)

---

## üìä Progress Tracker

### Overall Progress
- [ ] Milestone 1: Identity Module (0/16 tasks)
- [ ] Milestone 2: Lobby REST APIs (0/11 tasks)
- [ ] Milestone 3: SignalR Real-Time (0/16 tasks)
- [ ] Milestone 4: Engine Integration (0/8 tasks)
- [ ] Milestone 5: Frontend (0/10 tasks)
- [ ] Milestone 6: Docker & Deployment (0/8 tasks)

**Total:** 0/69 tasks completed (0%)

---

## üéâ V1 Release Criteria

The project is ready for v1 release when:
- ‚úÖ All 6 milestones completed
- ‚úÖ All tests passing
- ‚úÖ Can play full match (register ‚Üí login ‚Üí lobby ‚Üí game ‚Üí summary)
- ‚úÖ No critical bugs
- ‚úÖ Runs via Docker Compose
- ‚úÖ Basic documentation written (README, API docs)

---

**Last Updated:** October 8, 2025  
**Document Version:** 1.0.0
